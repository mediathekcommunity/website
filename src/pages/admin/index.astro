---
import AdminLayout from "../../layouts/AdminLayout.astro";

// Authentication check
const isAuthenticated = Astro.locals.isAuthenticated;
 
// Fetch content statistics from API
let contentStats = { movies: 0, series: 0, yMovies: 0, ySeries: 0, total: 0 };
let channelStats = { total: 0, countries: 0 };
let recentContent = [];

try {
	// Get content data
	const contentRes = await fetch(
		`${Astro.url.origin}/api/list-content?source=local`,
	);
	const contentData = await contentRes.json();

	if (contentData.success && contentData.files) {
		const files = contentData.files;
		contentStats.total = files.length;
		contentStats.movies = files.filter(
			(item: any) => item.type === "movie",
		).length;
		contentStats.series = files.filter(
			(item: any) => item.type === "series",
		).length;
		contentStats.yMovies = files.filter(
			(item: any) => item.type === "y-movie",
		).length;
		contentStats.ySeries = files.filter(
			(item: any) => item.type === "y-series",
		).length;

		// Get 5 most recent items
		recentContent = files.slice(0, 5);
	}

	// Get channel data
	const channelsRes = await fetch(
		`${Astro.url.origin}/api/channels?source=local`,
	);
	const channelsData = await channelsRes.json();

	if (channelsData.success && channelsData.channels) {
		channelStats.total = channelsData.channels.length;
		const countries = new Set(
			channelsData.channels.map((ch: any) => ch.country),
		);
		channelStats.countries = countries.size;
	}
} catch (error) {
}
---

<AdminLayout>
  <!-- Dashboard Header -->
  <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-8">
    <div>
      <h1 class="text-3xl font-bold text-base-content">Dashboard Overview</h1>
      <p class="text-base-content/70 mt-1">Monitor your content library and system health</p>
    </div>
    <div class="flex gap-2">
      <a href="/admin/content/create" class="btn btn-primary gap-2">
        <span>➕</span>
        New Content
      </a>
      <button class="btn btn-outline gap-2" onclick="location.reload()">
        <span>🔄</span>
        Refresh
      </button>
    </div>
  </div>

  <!-- Main Statistics -->
  <div class="stats stats-vertical lg:stats-horizontal shadow mb-8 w-full">
    <div class="stat place-items-center">
      <div class="stat-figure text-primary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4z" />
        </svg>
      </div>
      <div class="stat-title">Total Content</div>
      <div class="stat-value text-primary">{contentStats.total}</div>
      <div class="stat-desc">All media items</div>
    </div>

    <div class="stat place-items-center">
      <div class="stat-figure text-secondary">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4z" />
        </svg>
      </div>
      <div class="stat-title">Movies</div>
      <div class="stat-value text-secondary">{contentStats.movies}</div>
      <div class="stat-desc">Feature films</div>
    </div>

    <div class="stat place-items-center">
      <div class="stat-figure text-accent">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4z" />
        </svg>
      </div>
      <div class="stat-title">Series</div>
      <div class="stat-value text-accent">{contentStats.series}</div>
      <div class="stat-desc">TV Shows</div>
    </div>

    <div class="stat place-items-center">
      <div class="stat-figure text-info">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2h4a1 1 0 110 2h-1v14a2 2 0 01-2 2H6a2 2 0 01-2-2V6H3a1 1 0 110-2h4z" />
        </svg>
      </div>
      <div class="stat-title">Channels</div>
      <div class="stat-value text-info">{channelStats.total}</div>
      <div class="stat-desc">{channelStats.countries} countries</div>
    </div>
  </div>

  <!-- Content breakdown and Recent Activity -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Content Type Breakdown -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title gap-2">
          <span>📊</span>
          Content Breakdown
        </h2>
        <div class="space-y-3">
          <div class="flex justify-between items-center">
            <span class="text-sm">Adult Movies</span>
            <div class="flex items-center gap-2">
              <progress class="progress progress-primary w-20" value={contentStats.movies} max={contentStats.total}></progress>
              <span class="badge badge-primary badge-sm">{contentStats.movies}</span>
            </div>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Adult Series</span>
            <div class="flex items-center gap-2">
              <progress class="progress progress-secondary w-20" value={contentStats.series} max={contentStats.total}></progress>
              <span class="badge badge-secondary badge-sm">{contentStats.series}</span>
            </div>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Youth Movies</span>
            <div class="flex items-center gap-2">
              <progress class="progress progress-accent w-20" value={contentStats.yMovies} max={contentStats.total}></progress>
              <span class="badge badge-accent badge-sm">{contentStats.yMovies}</span>
            </div>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-sm">Youth Series</span>
            <div class="flex items-center gap-2">
              <progress class="progress progress-info w-20" value={contentStats.ySeries} max={contentStats.total}></progress>
              <span class="badge badge-info badge-sm">{contentStats.ySeries}</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Recent Content -->
    <div class="card bg-base-100 shadow-xl lg:col-span-2">
      <div class="card-body">
        <h2 class="card-title gap-2">
          <span>🕒</span>
          Recent Content
        </h2>
        <div class="overflow-x-auto">
          <table class="table table-xs">
            <thead>
              <tr>
                <th>Title</th>
                <th>Type</th>
                <th>Last Modified</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {recentContent.map((item: any) => (
                <tr>
                  <td>
                    <div class="font-medium truncate max-w-xs" title={item.title}>
                      {item.title || item.id}
                    </div>
                  </td>
                  <td>
                    <span class={`badge badge-sm ${
                      item.type === 'movie' ? 'badge-primary' :
                      item.type === 'series' ? 'badge-secondary' :
                      item.type === 'y-movie' ? 'badge-accent' :
                      'badge-info'
                    }`}>
                      {item.type}
                    </span>
                  </td>
                  <td class="text-xs opacity-70">
                    {new Date(item.lastModified).toLocaleDateString()}
                  </td>
                  <td>
                    <a href={`/admin/content/edit/${item.id}`} class="btn btn-ghost btn-xs">
                      Edit
                    </a>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
          {recentContent.length === 0 && (
            <div class="text-center py-8 text-base-content/50">
              No recent content found
            </div>
          )}
        </div>
        <div class="card-actions justify-end">
          <a href="/admin/content" class="btn btn-primary btn-sm">View All Content</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
    <a href="/admin/content/create" class="card bg-gradient-to-br from-primary to-primary/80 text-primary-content shadow-xl hover:shadow-2xl transition-all">
      <div class="card-body items-center text-center">
        <span class="text-3xl mb-2">➕</span>
        <h3 class="card-title text-sm">Create Content</h3>
        <p class="text-xs opacity-80">Add new movies or series</p>
      </div>
    </a>

    <a href="/admin/content" class="card bg-gradient-to-br from-secondary to-secondary/80 text-secondary-content shadow-xl hover:shadow-2xl transition-all">
      <div class="card-body items-center text-center">
        <span class="text-3xl mb-2">📋</span>
        <h3 class="card-title text-sm">Manage Content</h3>
        <p class="text-xs opacity-80">Edit existing content</p>
      </div>
    </a>

    <a href="/admin/channels" class="card bg-gradient-to-br from-accent to-accent/80 text-accent-content shadow-xl hover:shadow-2xl transition-all">
      <div class="card-body items-center text-center">
        <span class="text-3xl mb-2">📺</span>
        <h3 class="card-title text-sm">Channels</h3>
        <p class="text-xs opacity-80">Manage TV channels</p>
      </div>
    </a>

    <a href="/admin/health" class="card bg-gradient-to-br from-info to-info/80 text-info-content shadow-xl hover:shadow-2xl transition-all">
      <div class="card-body items-center text-center">
        <span class="text-3xl mb-2">❤️</span>
        <h3 class="card-title text-sm">System Health</h3>
        <p class="text-xs opacity-80">Monitor system status</p>
      </div>
    </a>
  </div>

  <!-- Analytics Dashboard -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    <!-- Content Growth Chart -->
    <div class="card bg-base-100 shadow-xl lg:col-span-2">
      <div class="card-body">
        <h2 class="card-title gap-2 mb-4">
          <span>📈</span>
          Content Growth
        </h2>
        <div class="flex justify-center items-center h-48 bg-base-200 rounded-lg">
          <div class="text-center">
            <div class="text-4xl mb-2">📊</div>
            <p class="text-base-content/60">Analytics chart placeholder</p>
            <p class="text-xs text-base-content/40">Chart.js or similar library integration</p>
          </div>
        </div>
        <div class="grid grid-cols-3 gap-4 mt-4">
          <div class="text-center">
            <div class="text-lg font-bold text-primary">+{Math.floor(Math.random() * 20) + 5}</div>
            <div class="text-xs opacity-60">This Month</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-secondary">+{Math.floor(Math.random() * 50) + 10}</div>
            <div class="text-xs opacity-60">This Year</div>
          </div>
          <div class="text-center">
            <div class="text-lg font-bold text-accent">{Math.floor(Math.random() * 10) + 15}%</div>
            <div class="text-xs opacity-60">Growth Rate</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Top Channels -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title gap-2 mb-4">
          <span>🏆</span>
          Top Channels
        </h2>
        <div class="space-y-3">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="fi fi-de w-4 h-3"></span>
              <span class="text-sm font-medium">ARD</span>
            </div>
            <div class="flex items-center gap-2">
              <progress class="progress progress-primary w-16 h-2" value="95" max="100"></progress>
              <span class="text-xs opacity-60">95%</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="fi fi-de w-4 h-3"></span>
              <span class="text-sm font-medium">ZDF</span>
            </div>
            <div class="flex items-center gap-2">
              <progress class="progress progress-secondary w-16 h-2" value="87" max="100"></progress>
              <span class="text-xs opacity-60">87%</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="fi fi-us w-4 h-3"></span>
              <span class="text-sm font-medium">CNN</span>
            </div>
            <div class="flex items-center gap-2">
              <progress class="progress progress-accent w-16 h-2" value="78" max="100"></progress>
              <span class="text-xs opacity-60">78%</span>
            </div>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="fi fi-gb w-4 h-3"></span>
              <span class="text-sm font-medium">BBC</span>
            </div>
            <div class="flex items-center gap-2">
              <progress class="progress progress-info w-16 h-2" value="72" max="100"></progress>
              <span class="text-xs opacity-60">72%</span>
            </div>
          </div>
        </div>
        <div class="card-actions justify-end mt-4">
          <a href="/admin/channels" class="btn btn-sm btn-outline">View All</a>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>

<script>
  // Simple dashboard functionality
  document.addEventListener('DOMContentLoaded', function() {
    // System ready
  });

  // Auto-refresh dashboard data every 2 minutes
  setInterval(async () => {
    try {
      // Dashboard refresh logic would go here
    } catch (error) {
      // Handle refresh errors silently
    }
  }, 120000);
</script>
